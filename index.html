<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stuttgart Property Tracker</title>
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            --color-green-500: rgba(34, 197, 94, 1);

            --color-bg-1: rgba(33, 128, 141, 0.08);
            --color-bg-2: rgba(230, 129, 97, 0.08);
            --color-bg-3: rgba(34, 197, 94, 0.08);

            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-border: rgba(94, 82, 64, 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(94, 82, 64, 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-focus-ring: rgba(33, 128, 141, 0.4);

            --font-size-base: 14px;
            --font-size-sm: 12px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --space-4: 4px;
            --space-6: 6px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04);
            --duration-fast: 150ms;
            --duration-normal: 250ms;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
        }

        body {
            padding: var(--space-16);
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: var(--font-size-3xl);
            margin: 0 0 var(--space-8) 0;
            color: var(--color-text);
        }

        .subtitle {
            font-size: var(--font-size-md);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-24);
        }

        .controls-section {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-20);
            margin-bottom: var(--space-24);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-16);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-8);
        }

        .form-group label {
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--color-text);
        }

        .form-group input, .form-group select {
            padding: var(--space-8) var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            font-size: var(--font-size-md);
            background: var(--color-background);
            color: var(--color-text);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .form-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--space-12) center;
            background-size: 16px;
            padding-right: var(--space-32);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-focus-ring);
        }

        .btn {
            padding: var(--space-8) var(--space-20);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--duration-normal);
        }

        .btn-primary {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: transparent;
            color: var(--color-primary);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-border);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .source-badges {
            display: flex;
            gap: var(--space-8);
            flex-wrap: wrap;
            margin-top: var(--space-12);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4) var(--space-12);
            border-radius: var(--radius-base);
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            transition: opacity var(--duration-fast);
            border: 1px solid transparent;
        }

        .badge input {
            margin: 0;
            cursor: pointer;
        }

        .badge--sparkasse {
            background: var(--color-bg-1);
            color: var(--color-teal-500);
            border-color: var(--color-teal-500);
        }

        .badge--volksbank {
            background: var(--color-bg-2);
            color: var(--color-orange-500);
            border-color: var(--color-orange-500);
        }

        .badge--lbs {
            background: var(--color-bg-3);
            color: var(--color-green-500);
            border-color: var(--color-green-500);
        }

        .badge:hover {
            opacity: 0.8;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-24);
        }

        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-16);
            text-align: center;
        }

        .stat-value {
            font-size: var(--font-size-2xl);
            font-weight: 600;
            color: var(--color-primary);
            margin: var(--space-8) 0;
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .sort-controls {
            display: flex;
            gap: var(--space-8);
            margin-bottom: var(--space-16);
            flex-wrap: wrap;
        }

        .sort-btn {
            padding: var(--space-8) var(--space-12);
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            border-radius: var(--radius-base);
            cursor: pointer;
            font-size: var(--font-size-sm);
            transition: all var(--duration-fast);
        }

        .sort-btn.active {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
            border-color: var(--color-primary);
        }

        .sort-btn:hover {
            border-color: var(--color-primary);
        }

        .property-card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-20);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-20);
            transition: box-shadow var(--duration-normal);
        }

        .property-card:hover {
            box-shadow: var(--shadow-md);
        }

        @media (max-width: 768px) {
            .property-card {
                grid-template-columns: 1fr;
            }
        }

        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--space-12);
        }

        .property-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-text);
            margin: 0;
        }

        .property-source {
            display: inline-block;
            font-size: var(--font-size-sm);
            font-weight: 500;
            padding: var(--space-4) var(--space-12);
            border-radius: var(--radius-base);
        }

        .source-sparkasse {
            background: var(--color-bg-1);
            color: var(--color-teal-500);
        }

        .source-volksbank {
            background: var(--color-bg-2);
            color: var(--color-orange-500);
        }

        .source-lbs {
            background: var(--color-bg-3);
            color: var(--color-green-500);
        }

        .property-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-16);
            margin-bottom: var(--space-16);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-4);
        }

        .detail-value {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-text);
        }

        .price-highlight {
            color: var(--color-primary);
            font-size: var(--font-size-2xl);
        }

        .alert-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-6);
            padding: var(--space-8) var(--space-12);
            background: rgba(34, 197, 94, 0.1);
            color: var(--color-green-500);
            border-radius: var(--radius-base);
            font-size: var(--font-size-sm);
            font-weight: 500;
            margin-top: var(--space-12);
        }

        .days-on-market {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            padding: var(--space-12);
            background: var(--color-bg-2);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
        }

        .days-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--color-orange-500);
            color: var(--color-btn-primary-text);
            border-radius: 50%;
            font-weight: 600;
            font-size: var(--font-size-base);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-32);
            color: var(--color-text-secondary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: var(--space-16);
        }

        .filter-info {
            background: var(--color-bg-1);
            border: 1px solid var(--color-teal-500);
            border-radius: var(--radius-base);
            padding: var(--space-12);
            font-size: var(--font-size-sm);
            color: var(--color-teal-500);
            margin-bottom: var(--space-16);
        }

        .api-status {
            padding: var(--space-12);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
            font-size: var(--font-size-sm);
        }

        .api-status.success {
            background: rgba(34, 197, 94, 0.1);
            color: var(--color-green-500);
            border: 1px solid var(--color-green-500);
        }

        .api-status.error {
            background: rgba(192, 21, 47, 0.1);
            color: var(--color-red-500);
            border: 1px solid var(--color-red-500);
        }

        .loading {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>üè† Regional Property Tracker</h1>
    <p class="subtitle">Stuttgart, B√∂blingen, Ludwigsburg, Rems-Murr, Filderstadt - track bank portals before ImmoScout24</p>

    <div class="controls-section">
        <div class="form-group">
            <label>Min Price (‚Ç¨)</label>
            <input type="number" id="minPrice" placeholder="200000" value="200000" min="0" step="10000">
        </div>
        <div class="form-group">
            <label>Max Price (‚Ç¨)</label>
            <input type="number" id="maxPrice" placeholder="800000" value="800000" min="0" step="10000">
        </div>
        <div class="form-group">
            <label>Min Area (m¬≤)</label>
            <input type="number" id="minArea" placeholder="50" value="70" min="0" step="10">
        </div>
        <div class="form-group">
            <label>Region</label>
            <select id="region">
                <option value="">All Regions</option>
                <option value="70">Stuttgart (70xxx)</option>
                <option value="71">B√∂blingen/Sindelfingen (71xxx)</option>
                <option value="714">Ludwigsburg (714xx)</option>
                <option value="713">Rems-Murr-Kreis (713xx)</option>
                <option value="7034">Filderstadt (7034x)</option>
            </select>
        </div>
    </div>

    <div class="controls-section">
        <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: var(--space-12); font-weight: 500;">Data Sources</label>
            <div class="source-badges">
                <label class="badge badge--sparkasse">
                    <input type="checkbox" id="source-sparkasse" checked>
                    <span>Sparkasse Regional</span>
                </label>
                <label class="badge badge--volksbank">
                    <input type="checkbox" id="source-volksbank" checked>
                    <span>Volksbank Stuttgart/Filder</span>
                </label>
                <label class="badge badge--lbs">
                    <input type="checkbox" id="source-lbs" checked>
                    <span>LBS & BW-Bank</span>
                </label>
            </div>
        </div>
        <div style="grid-column: 1 / -1; margin-top: var(--space-12);">
            <button class="btn btn-primary" id="searchBtn" onclick="searchProperties()">üîç Search Properties</button>
            <button class="btn btn-secondary" onclick="clearFilters()" style="margin-left: var(--space-8);">Clear</button>
        </div>
    </div>

    <div id="apiStatus"></div>

    <div class="stats-grid" id="statsGrid" style="display: none;">
        <div class="stat-card">
            <div class="stat-label">Total Found</div>
            <div class="stat-value" id="totalCount">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg Price/m¬≤</div>
            <div class="stat-value" id="avgPrice">‚Ç¨0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Pre-Market (0-7 days)</div>
            <div class="stat-value" id="preMarket">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Market Advantage (hrs)</div>
            <div class="stat-value" id="timeAdvantage">-</div>
        </div>
    </div>

    <div id="filterInfo"></div>

    <div class="sort-controls" id="sortControls" style="display: none;">
        <button class="sort-btn active" onclick="setSortOrder('price-asc')">üí∞ Cheapest First</button>
        <button class="sort-btn" onclick="setSortOrder('price-desc')">üíé Most Expensive</button>
        <button class="sort-btn" onclick="setSortOrder('newest')">üÜï Newest First</button>
        <button class="sort-btn" onclick="setSortOrder('largest')">üìê Largest First</button>
    </div>

    <div class="results-section" id="results"></div>

    <script>
        // Serverless Config: Fetch static JSON directly
        // Fallback: If local file not found, try raw GitHub URL (adjust 'main' if branch is different)
        const DATA_URL_LOCAL = '../properties_cache.json';
        const DATA_URL_REMOTE = 'https://raw.githubusercontent.com/kaustubhg101/stuttgart-property-tracker/main/properties_cache.json';

        let allPropertiesData = [];
        let currentSort = 'price-asc';
        let filteredProperties = [];

        async function searchProperties() {
            const searchBtn = document.getElementById('searchBtn');
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<span class="loading">‚è≥</span> Loading Data...';

            try {
                // Fetch data if we haven't already
                if (allPropertiesData.length === 0) {
                    try {
                        // Try local file first (best for dev)
                        const response = await fetch(DATA_URL_LOCAL);
                        if (!response.ok) throw new Error('Local file not found');
                        const data = await response.json();
                        allPropertiesData = data.properties || [];
                        showApiStatus('‚úÖ Loaded data from local cache', 'success');
                    } catch (e) {
                        console.log('Local fetch failed, trying remote...', e);
                        // Fallback to Raw GitHub URL
                        const response = await fetch(DATA_URL_REMOTE);
                        if (!response.ok) throw new Error('Failed to load data from repository');
                        const data = await response.json();
                        allPropertiesData = data.properties || [];
                        showApiStatus('‚úÖ Loaded data from GitHub Repository', 'success');
                    }
                }

                // Apply Filters locally
                applyFilters();

            } catch (error) {
                console.error('Data loading error:', error);
                showApiStatus(`‚ö†Ô∏è Could not load property data: ${error.message}`, 'error');
                filteredProperties = [];
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = 'üîç Search Properties';
                displayResults();
                displayStats();
            }
        }

        function applyFilters() {
            const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;
            const minArea = parseFloat(document.getElementById('minArea').value) || 0;
            const region = document.getElementById('region').value.trim();

            const sources = [];
            if (document.getElementById('source-sparkasse').checked) sources.push('sparkasse');
            if (document.getElementById('source-volksbank').checked) sources.push('volksbank');
            if (document.getElementById('source-lbs').checked) sources.push('lbs');
            // Allow other sources (e.g. kskbb) if they map to one of the checked types or just show all if checked
            // Simplification: checking 'sparkasse' includes 'kskbb' if we want, or we rely on exact string match.
            // Let's assume exact match for now, or partial match if needed.
            
            filteredProperties = allPropertiesData.filter(prop => {
                const priceMatch = prop.price >= minPrice && prop.price <= maxPrice;
                const areaMatch = prop.area >= minArea;
                
                // Simple region match (zip code prefix)
                let regionMatch = true;
                if (region) {
                    regionMatch = prop.location.includes(region) || 
                                  (prop.zipCode && prop.zipCode.startsWith(region)); 
                }

                // Source match (flexible)
                let sourceMatch = false;
                if (sources.includes(prop.source)) sourceMatch = true;
                // Map 'kskbb' to 'sparkasse' for filtering if needed
                if (prop.source === 'kskbb' && sources.includes('sparkasse')) sourceMatch = true;

                return priceMatch && areaMatch && regionMatch && sourceMatch;
            });
        }

        function showApiStatus(message, status) {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.className = `api-status ${status}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function displayResults() {
            const resultsDiv = document.getElementById('results');
            const sortControls = document.getElementById('sortControls');
            const filterInfo = document.getElementById('filterInfo');

            if (filteredProperties.length === 0) {
                resultsDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">üîç</div><p>No properties found matching your criteria</p></div>';
                sortControls.style.display = 'none';
                filterInfo.innerHTML = '';
                return;
            }

            sortControls.style.display = 'flex';

            const sorted = [...filteredProperties].sort((a, b) => {
                switch(currentSort) {
                    case 'price-asc': return a.price - b.price;
                    case 'price-desc': return b.price - a.price;
                    case 'newest': return (new Date(b.scrapedAt) - new Date(a.scrapedAt)); // Approximate "newest" by scrape time or daysOnMarket
                    case 'largest': return b.area - a.area;
                    default: return 0;
                }
            });

            // Calculate pre-market based on scrapedAt date if daysOnMarket is missing
            const now = new Date();
            const preMarketCount = sorted.filter(p => {
                const scrapedDate = new Date(p.scrapedAt);
                const diffTime = Math.abs(now - scrapedDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                return diffDays <= 7;
            }).length;

            filterInfo.innerHTML = `<div class="filter-info">Showing ${sorted.length} properties - ${preMarketCount} recently found</div>`;

            resultsDiv.innerHTML = sorted.map(prop => {
                const pricePerSqm = prop.area > 0 ? Math.round(prop.price / prop.area) : 0;
                // Fallback for missing fields
                const features = prop.features || [];
                const yearBuilt = prop.yearBuilt || '-';
                const heatingType = prop.heatingType || '-';
                
                // Calculate age of listing
                const scrapedDate = new Date(prop.scrapedAt);
                const diffDays = Math.ceil(Math.abs(new Date() - scrapedDate) / (1000 * 60 * 60 * 24));
                const isNew = diffDays <= 3;

                return `
                    <div class="property-card">
                        <div>
                            <div class="property-header">
                                <h3 class="property-title"><a href="${prop.url}" target="_blank" style="text-decoration: none; color: inherit;">${prop.title}</a></h3>
                                <span class="property-source source-${prop.source}">${prop.source}</span>
                            </div>
                            <p style="margin: 0 0 var(--space-12) 0; color: var(--color-text-secondary); font-size: var(--font-size-sm);">${prop.location}</p>
                            
                            ${isNew ? `<div class="alert-badge"><span>‚ö°</span> New Listing</div>` : ''}
                            
                            <div class="days-on-market">
                                <div class="days-badge">${diffDays}d</div>
                                <div>
                                    <div style="font-weight: 600;">Tracked since</div>
                                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">${scrapedDate.toLocaleDateString()}</div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="property-details">
                                <div class="detail-item">
                                    <div class="detail-label">Price</div>
                                    <div class="detail-value price-highlight">‚Ç¨${prop.price.toLocaleString('de-DE')}</div>
                                    <div class="detail-label" style="margin-top: var(--space-8); font-size: var(--font-size-sm);">‚Ç¨${pricePerSqm.toLocaleString('de-DE')}/m¬≤</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Area</div>
                                    <div class="detail-value">${prop.area}m¬≤</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Rooms</div>
                                    <div class="detail-value">${prop.rooms || '-'}</div>
                                </div>
                            </div>
                            
                            <div>
                                <div style="font-size: var(--font-size-sm); font-weight: 500; margin-bottom: var(--space-8); color: var(--color-text-secondary);">Details</div>
                                <div style="display: flex; flex-wrap: wrap; gap: var(--space-6); margin-bottom: var(--space-12);">
                                    ${yearBuilt !== '-' ? `<span style="display: inline-block; background: var(--color-bg-3); color: var(--color-green-500); padding: var(--space-4) var(--space-8); border-radius: var(--radius-base); font-size: var(--font-size-sm);">üèóÔ∏è ${yearBuilt}</span>` : ''}
                                    ${heatingType !== '-' ? `<span style="display: inline-block; background: var(--color-bg-2); color: var(--color-orange-500); padding: var(--space-4) var(--space-8); border-radius: var(--radius-base); font-size: var(--font-size-sm);">üî• ${heatingType}</span>` : ''}
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: var(--space-6);">
                                    ${features.map(f => `<span style="display: inline-block; background: var(--color-bg-1); color: var(--color-teal-500); padding: var(--space-4) var(--space-8); border-radius: var(--radius-base); font-size: var(--font-size-sm);">${f}</span>`).join('')}
                                </div>
                                <div style="margin-top: var(--space-16);">
                                    <a href="${prop.url}" target="_blank" class="btn btn-secondary" style="width: 100%; text-align: center; display: block; text-decoration: none;">View Expos√© ‚Üó</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayStats() {
            const statsGrid = document.getElementById('statsGrid');
            if (filteredProperties.length === 0) {
                statsGrid.style.display = 'none';
                return;
            }

            statsGrid.style.display = 'grid';

            const totalCount = filteredProperties.length;
            const avgPrice = Math.round(filteredProperties.reduce((sum, p) => sum + (p.price / (p.area || 1)), 0) / filteredProperties.length);
            
            // Re-calc pre-market for stats
            const now = new Date();
            const preMarket = filteredProperties.filter(p => {
                const diffDays = Math.ceil(Math.abs(now - new Date(p.scrapedAt)) / (1000 * 60 * 60 * 24));
                return diffDays <= 7;
            }).length;

            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('avgPrice').textContent = '‚Ç¨' + avgPrice.toLocaleString('de-DE');
            document.getElementById('preMarket').textContent = preMarket;
            document.getElementById('timeAdvantage').textContent = preMarket > 0 ? 'High' : '-';
        }

        function setSortOrder(order) {
            currentSort = order;
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displayResults();
        }

        function clearFilters() {
            document.getElementById('minPrice').value = '200000';
            document.getElementById('maxPrice').value = '800000';
            document.getElementById('minArea').value = '70';
            document.getElementById('region').value = '';
            document.getElementById('source-sparkasse').checked = true;
            document.getElementById('source-volksbank').checked = true;
            document.getElementById('source-lbs').checked = true;
            // Reset results
            applyFilters();
            displayResults();
            displayStats();
        }

        // Auto-search on load
        window.addEventListener('load', searchProperties);
    </script>
</body>
</html>
